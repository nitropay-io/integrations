<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crypto Payment Demo</title>
  <script type="importmap">
    {
      "imports": {
        "viem": "https://esm.sh/viem",
        "viem/chains": "https://esm.sh/viem/chains",
        "ethers": "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js",
        "axios": "https://esm.sh/axios",
        "@nitropay-io/sdk": "https://esm.sh/@nitropay-io/sdk@0.1.0/es2022/sdk.mjs"
      }
    }
  </script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 500px;
      margin: 2rem auto;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    label, select {
      display: block;
      margin: 1rem 0 0.5rem;
    }
    .token-options {
      margin-bottom: 1rem;
    }
    .token-options label {
      display: inline-block;
      margin-right: 1rem;
    }
    button {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      background-color: #0070f3;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Pay with Crypto</h1>

  <form id="paymentForm">
    <label for="selectedAmount">$ Amount</label>
    <input type="number" id="selectedAmount" name="selectedAmount" value="1">
    <label for="blockchainSelect">Select Blockchain:</label>
    <select id="blockchainSelect">
      <option value="">-- Choose Chain --</option>
    </select>

    <div class="token-options">
      <div id="tokenSelect">
      </div>
    </div>
    <button id="payButton" type="button" disabled>Pay</button>
  </form>

  <script type="module">
    import {
      createPublicClient,
      createWalletClient,
      http,
      custom,
      parseUnits
    } from 'viem'
    import { sepolia, seiTestnet } from 'viem/chains'
    import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/+esm'
    import { NitroPaySDK } from '@nitropay-io/sdk'

    const sdk = new NitroPaySDK({
      evmProvider: window.ethereum,
      publicKey: 'pk_b56d0c8b-ccca-4516-8783-8950689e27c7'
    });

    const approveAbi = [
        {
            type: 'function',
            name: 'approve',
            stateMutability: 'nonpayable',
            inputs: [
            { name: 'spender', type: 'address' },
            { name: 'amount', type: 'uint256' }
            ],
            outputs: [{ type: 'bool' }]
        }
    ]

    // ==== ABI used for pay() ====
    const paymentEscrowAbi = [
      {
        type: "function",
        name: "pay",
        stateMutability: "nonpayable",
        inputs: [
          { name: "intentId", type: "bytes32" },
          { name: "token", type: "address" },
          { name: "amount", type: "uint256" }
        ],
        outputs: []
      }
    ];

    const chainSelect = document.getElementById('blockchainSelect')
    const tokenSelect = document.getElementById('tokenSelect')
    const amountSelect = document.getElementById('selectedAmount')
    const payButton = document.getElementById('payButton')
    
    let selectedChain = null
    let selectedToken = null
    let selectedAmount = 1

    // Load chains dynamically
    async function loadChains() {

      const supported = await sdk.getSupportedChains();

      supported.forEach(chain => {
        const option = document.createElement('option')
        option.value = chain.id
        option.textContent = chain.name
        chainSelect.appendChild(option)
      })
    }

    async function loadTokens(chainId) {
      // retrieve tokens from API
      const tokens = await sdk.getSupportedTokens(chainId);
      
      // update UI
      tokens.forEach(token => {
        const label = document.createElement("label");

        const input = document.createElement("input");
        input.type = "radio";
        input.name = "token";
        input.value = token.tokenAddress;

        label.appendChild(input);
        label.appendChild(document.createTextNode(` ${token.symbol} (${token.tokenAddress})`));
        tokenSelect.appendChild(label);
        if(!selectedToken) {
          input.checked = true;
          selectedToken = token.tokenAddress;
        }
      })
    }

    chainSelect.addEventListener('change', async () => {
      if (chainSelect.value === '') {
        tokenSelect.replaceChildren();
        selectedChain = null;
        updateButtonState();
        return await Promise.resolve();
      }

      selectedChain = parseInt(chainSelect.value)
      tokenSelect.replaceChildren();
      await loadTokens(selectedChain);
      updateButtonState();
    })

    amountSelect.addEventListener('change', (evt) => {
      if(isNaN(evt.target.value)) {
        selectedAmount = 0;
      } else {
        selectedAmount = Number(evt.target.value);
      }
      updateButtonState();
    })

    document.querySelectorAll('input[name="token"]').forEach(el => {
      el.addEventListener('change', () => {
        selectedToken = document.querySelector('input[name="token"]:checked')?.value
        updateButtonState()
      })
    })

    function updateButtonState() {
      payButton.disabled = !(selectedChain && selectedToken && selectedAmount)
    }

    async function pay() {
      
      if(!(selectedChain && selectedToken && selectedAmount)) {
        return await Promise().resolve();
      }

      const amountInWei = ethers.utils.parseUnits(selectedAmount.toString(), 6);

      const response = await fetch('/payment-intent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          amount: amountInWei.toString(),
          token: selectedToken,
          chainId: Number(selectedChain)
        })
      });

      const paymentIntent = await response.json();
      
      const { intentId, vaultAddress, amount:intentAmount, tokenAddress } = paymentIntent;

      const receipt = await sdk.pay({
        intentId,
        chainId: Number(selectedChain),
        amount: intentAmount,
        tokenAddress,
        vaultAddress
      });
      
      return receipt;
    }

    // Handle payment
    payButton.addEventListener('click', async () => {
        try {
            const receiptTxHash = await pay();
            console.log('receiptTxHash', receiptTxHash);
        } catch (error) {
          console.log(error)
            alert('Error: ' + error)
        }
    });

    loadChains();
  </script>
</body>
</html>
