<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crypto Payment Demo</title>
  <script type="importmap">
    {
      "imports": {
        "viem": "https://esm.sh/viem",
        "viemChains": "https://esm.sh/viem/chains",
        "ethers": "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js",
        "@nitropay-io/sdk" : "https://raw.githubusercontent.com/nitropay-io/merchant-payment-examples/js-vanilla/nitropay-io-sdk.mjs"
      }
    }
  </script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 500px;
      margin: 2rem auto;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    label, select {
      display: block;
      margin: 1rem 0 0.5rem;
    }
    .token-options {
      margin-bottom: 1rem;
    }
    .token-options label {
      display: inline-block;
      margin-right: 1rem;
    }
    button {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      background-color: #0070f3;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Pay with Crypto</h1>

  <form id="paymentForm">
    <label for="blockchainSelect">Select Blockchain:</label>
    <select id="blockchainSelect">
      <option value="">-- Choose Chain --</option>
    </select>

    <div class="token-options">
      <label><input type="radio" name="token" value="USDT" /> USDT</label>
      <label><input type="radio" name="token" value="USDC" /> USDC</label>
    </div>

    <button id="payButton" type="button" disabled>Pay</button>
  </form>

  <script type="module">
    import {
      createPublicClient,
      createWalletClient,
      http,
      custom,
      parseUnits
    } from 'viem'
    import { sepolia, seiTestnet } from 'viemChains'
    import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/+esm'

    const approveAbi = [
        {
            type: 'function',
            name: 'approve',
            stateMutability: 'nonpayable',
            inputs: [
            { name: 'spender', type: 'address' },
            { name: 'amount', type: 'uint256' }
            ],
            outputs: [{ type: 'bool' }]
        }
    ]

    // ==== ABI used for pay() ====
    const paymentEscrowAbi = [
      {
        type: "function",
        name: "pay",
        stateMutability: "nonpayable",
        inputs: [
          { name: "intentId", type: "bytes32" },
          { name: "token", type: "address" },
          { name: "amount", type: "uint256" }
        ],
        outputs: []
      }
    ];

    const chainsMap = {
      [sepolia.id] : sepolia,
      [seiTestnet.id]: seiTestnet
    }

    const vaultAddress = '0xa823950Dad968CBe7c52783dD14C056F15348682'
    const tokenAddresses = {
      [sepolia.id]: { USDC: '0x1c7d4b196cb0c7b01d743fbc6116a902379c7238', USDT: '0x7169d38820dfd117c3fa1f22a697dba58d90ba06' }
    }

    const chainSelect = document.getElementById('blockchainSelect')
    const payButton = document.getElementById('payButton')

    let selectedChain = sepolia.id
    let selectedToken = 'USDC'

    // Load chains dynamically
    function loadChains() {
      const supported = [
        { id: sepolia.id, name: sepolia.name }
      ]
      supported.forEach(chain => {
        const option = document.createElement('option')
        option.value = chain.id
        option.textContent = chain.name
        chainSelect.appendChild(option)
      })
    }

    chainSelect.addEventListener('change', () => {
      selectedChain = parseInt(chainSelect.value)
      updateButtonState()
    })

    document.querySelectorAll('input[name="token"]').forEach(el => {
      el.addEventListener('change', () => {
        selectedToken = document.querySelector('input[name="token"]:checked')?.value
        updateButtonState()
      })
    })

    function updateButtonState() {
      payButton.disabled = !(selectedChain && selectedToken)
    }

    async function pay() {

        const chain = chainsMap[selectedChain]
        const ethereum = window.ethereum || window.phantom.ethereum
        const amount = parseUnits('1', 6);

        if (!ethereum) throw new Error(`No ethereum provider found`)
        if (!chain) throw new Error(`Unsupported chain ${chainId}`)

        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const account = accounts[0];
        
        const publicClient = createPublicClient({
            account,
            chain: chain,
            transport: http(),
        })

        const walletClient = createWalletClient({
            account,
            chain: chain,
            transport: custom(ethereum)
        })
        
        const approveTx = await walletClient.writeContract({
            chain: chain,
            account: await walletClient.getAddresses()[0],
            to: tokenAddresses[chain.id][selectedToken],
            abi: approveAbi,
            functionName: 'approve',
            args: [vaultAddress, amount]
        })
        await publicClient.waitForTransactionReceipt({ hash: approveTx })
        
        const intentIdBytes32 = '0x' + Array.from(crypto.getRandomValues(new Uint8Array(32)), b => b.toString(16).padStart(2, '0')).join('')

        const payHash = await walletClient.writeContract({
            account: await walletClient.getAddresses()[0],
            to: vaultAddress,
            abi: paymentEscrowAbi,
            functionName: 'pay',
            args: [intentIdBytes32, tokenAddresses[chain.id][selectedToken], amount],
        })

        const receipt = await publicClient.waitForTransactionReceipt({ hash: payHash })
        
        return receipt;
    }

    // Handle payment
    payButton.addEventListener('click', async () => {
        try {
            const receipt = await pay();
            console.log(receipt)
        } catch (error) {
            alert('Error: ' + error)
        }
    });

    loadChains();
  </script>
</body>
</html>
